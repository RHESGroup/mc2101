
# **************************************************************************************
#	Filename:	synthesis.tcl
#	Project:	CNL_RISC-V
#  	Version:	2.0
#	History:
#	Date:		13 May 2024
#
# Copyright (C) 2024 CINI Cybersecurity National Laboratory
#
# This source file may be used and distributed without
# restriction provided that this copyright statement is not
# removed from the file and that any derivative work contains
# the original copyright notice and the associated disclaimer.
#
# This source file is free software; you can redistribute it
# and/or modify it under the terms of the GNU Lesser General
# Public License as published by the Free Software Foundation;
# either version 3.0 of the License, or (at your option) any
# later version.
#
# This source is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied
# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
# PURPOSE. See the GNU Lesser General Public License for more
# details.
#
# You should have received a copy of the GNU Lesser General
# Public License along with this source; if not, download it
# from https://www.gnu.org/licenses/lgpl-3.0.txt
#
# **************************************************************************************
#
#	File content description:
#	#quartus synthesis flow
#	#hdl compile -> hdl syn -> place & route -> static timing analysis -> programmer 
#
# **************************************************************************************

set project_name "mc2101"
set make_assignment 1
set close_project 0
set SDC_FILE "mc2101.sdc"

#open project or create it if doesn't exist
package require ::quartus::project

if {[is_project_open]} {
    #there is an open project, do not export assignment
    if {[string compare $quartus(project) $project_name]} {
        puts "Project $project_name is not open"
        set make_assignment 0
    }
} else {
    #open or create new project
    if {[project_exists $project_name]} {
        project_open $project_name
    } else {
        puts "Project $project_name doesn't exist, creting it.."
        project_new $project_name -overwrite
    }
    #project needs to be closed after everything is completed
    set close_project 1
}

#set project assignment and commit them!
if {$make_assignment} {
    set_global_assignment -name FAMILY "Cyclone V" 
    set_global_assignment -name DEVICE 5CSEMA5F31C6
    set_global_assignment -name PROJECT_OUTPUT_DIRECTORY output_files
    set_global_assignment -name RESERVE_ALL_UNUSED_PINS_WEAK_PULLUP "AS INPUT TRI-STATED"
    set_global_assignment -name TOP_LEVEL_ENTITY mc2101
    
    #clean VHDL_FILE global assignment
    remove_all_global_assignments -name VHDL_FILE

    #Open the file for reading(The file generated by BENDER)
    set file_id [open "add_sources.txt" r]

    set match 1

    # Read each line of the file
    puts "These were the sources added to the project:"
    while {[gets $file_id line] != -1} {

        if {$match == 1} { #Search through the file unitl the ROOT is found

            #Set the value of the variable ROOT
            set match [ regexp {"([\/| a-zA-Z0-9|\-|\_|\.]+)"} $line general_match ROOT]

        } 

        # Check if the string matches the regular expression
        if {[regexp {(\s.".ROOT/+[a-zA-Z0-9|\.|/|\-|\_]+")} $line pattern]} {
            
            # Replace the value of $ROOT for the real path 
            set final_pattern [regsub -all {.ROOT} $pattern $ROOT]

            #Add the VHDL files to the project
            set_global_assignment -name VHDL_FILE $final_pattern -hdl_version VHDL_2008
            puts $final_pattern

        }
    }

    # Close the file
    close $file_id
    file delete "add_sources.txt"
    
    puts "Done -- The add_sources.txt was deleted successfully"


    #sys_clk-->50 MHz clock
    set_location_assignment PIN_AF14 -to sys_clk
    #sys_rst_n-->KEY0 (button)
    set_location_assignment PIN_AA14 -to sys_rst_n
    #uart_tx-->2x20 GPIO Exapansion Headers GPIO_0[1]
    set_location_assignment PIN_Y17 -to uart_tx
    #uart_rx-->2x20 GPIO Exapansion Headers GPIO_0[3]
    set_location_assignment PIN_Y18 -to uart_rx
    #gpio[0 TO 9]-->slide switches SW[0 TO 9]
    set_location_assignment PIN_AB12 -to gpio_pads[0]
    set_location_assignment PIN_AC12 -to gpio_pads[1]
    set_location_assignment PIN_AF9  -to gpio_pads[2]
    set_location_assignment PIN_AF10 -to gpio_pads[3]
    set_location_assignment PIN_AD11 -to gpio_pads[4]
    set_location_assignment PIN_AD12 -to gpio_pads[5]
    set_location_assignment PIN_AE11 -to gpio_pads[6]
    set_location_assignment PIN_AC9  -to gpio_pads[7]
    set_location_assignment PIN_AD10 -to gpio_pads[8]
    set_location_assignment PIN_AE12 -to gpio_pads[9]
    #gpio[10 TO 19]-->leds LED[0 TO 9]
    set_location_assignment PIN_V16 -to gpio_pads[10]
    set_location_assignment PIN_W16 -to gpio_pads[11]
    set_location_assignment PIN_V17 -to gpio_pads[12]
    set_location_assignment PIN_V18 -to gpio_pads[13]
    set_location_assignment PIN_W17 -to gpio_pads[14]
    set_location_assignment PIN_W19 -to gpio_pads[15]
    set_location_assignment PIN_Y19 -to gpio_pads[16]
    set_location_assignment PIN_W20 -to gpio_pads[17]
    set_location_assignment PIN_W21 -to gpio_pads[18]
    set_location_assignment PIN_Y21 -to gpio_pads[19]
    #gpio[20 to 22]-->KEY1,2,3 Button
    set_location_assignment PIN_AA15 -to gpio_pads[20]
    set_location_assignment PIN_W15  -to gpio_pads[21]
    set_location_assignment PIN_Y16  -to gpio_pads[22]
    
    #commit assignment
    export_assignments
}

#######################################################
####check vhdl syntax before proceding to synthesis####
#######################################################
puts "(COMPILATION)"
set cmd "quartus_map --read_settings_files=on \
	                 --write_settings_files=off \
	                 $project_name \
	                 --optimize=balanced \
	        --state_machine_encoding=minimal_bits"
	                  
qexec $cmd

#######################################################
#############place and route process###################
#######################################################
puts "(FITTER)"
set cmd "quartus_fit --read_settings_files=on \
                     --write_settings_files=off \
	                 $project_name"
	             
qexec $cmd

#######################################################
#########static timing analysis process################
#######################################################	 
puts "(STA)"
set cmd "quartus_sta --sdc=$SDC_FILE \
	                 --do_report_timing \
	                 $project_name \
	                 -model=slow"

qexec $cmd	                 
puts "STA report can be found in output_files/ directory"

#######################################################
################Assembler process######################
#######################################################	                             
puts "(ASM)"
set cmd "quartus_asm --read_settings_files=on \
	                 --write_settings_files=off \
	                 $project_name"

qexec $cmd	                 
puts "Program file .sof can be found in ouput_files/ directory"


if {$close_project} {
    puts "Closing $project_name.."
    project_close
}
